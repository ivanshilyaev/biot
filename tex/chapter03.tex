\chapter{Криптографические угрозы и атаки}

	\section{ZigBee}
	Несколько вариантов атак на протокол ZigBee детально описаны в \cite{zigbee-attacks}. Среди прочих
	атак интерес вызывает так называемая атака повторной отправки сообщения, при которой в случае
	отсутствия в сети удостоверяющего центра или использования статического ключа шифрования
	злоумышленнику удаётся получить управления над конечными устройствами. Стоит отметить, что
	при правильной конфигурации сети устройства на основе ZigBee не подвержены атакам, направленным
	на этап присоединения нового устройства в сеть. Поскольку во всех трёх решения (ZigBee, Z-Wave, Wi-Fi)
	в том или ином виде используется алгоритм AES, шифрование данных оказывается весьма надёжным.
	И именно этап установки соединения является наиболее уязвимым. В отличие от ZigBee, подобным атакам
	оказываются подвержены два других решения, о чём пойдёт речь ниже.


	\section{Z-Wave}
	Домашняя автоматизация на сегодняшний день предлагает на рынке огромный выбор устройств. Некоторые
	из них потенциально не несут никакой угрозы, даже в случае взлома. Однако другие влияют напрямую на
	нашу безопасность. К таким устройствам можно отнести, например, автоматизированные дверные замки.
	В случае их компрометации последствия могут оказаться весьма неудачными. И такой случай
	имел место быть. В зашифрованных алгоритмом AES дверных замках на основе протокола Z-Wave была 
	обнаружена ранняя уязвимость. Использую её, злоумышленник получал возможность удалённо отпирать 
	двери без знания ключей шифрования. А после изменения ключей последующие сетевые сообщения, 
	например, <<дверь открыта>>, игнорировались установленным контроллером сети.
	Уязвимость не была связана с недостатком в спецификации Z-Wave, а являлась ошибкой 
	в реализации, допущенной производителем дверного замка.
	
	Безопасность протокола Z-Wave была улучшена в 2016 году с появлением спецификации Z-Wave S2 
	Security. Однако из-за обратной совместимости с предыдущей версией спецификации S0 устройства
	оказались по-прежнему уязвимы в процессе подключения. В Z-Wave S0 Security использовался статический
	первичный ключ, состоящий из 128 нулей, из-за чего дальнейший взлом и управление устройствами 
	оказывались весьма тривиальными. В качестве улучшения в S2 для первичной выработки ключей 
	используется протокол Диффи-Хеллмана, а также дополнительно может потребоваться ввод 5-символьного
	кода устройства. Но в 2018 году была обнародована атака, которая позволяла понижать версию 
	спецификации с S2 до S0 и эксплуатировать старые уязвимости.
	
	Рассмотрим более подробно процесс понижения версии. Первые шаги при сопряжении устройства и 
	контроллера в спецификация S0 и S2 аналогичны и заключаются в следующем:
	
	\begin{enumerate}
		\item На контроллере (управляющем устройстве) необходимо выбрать режим добавления нового
		устройства.
		\item Далее пользователь нажимает кнопку (или последовательность кнопок) на присоединяемом
		устройстве.
		\item После этого новое устройство посылает в сеть информацию о себе (Node info).
		\item Контроллер получает эту информацию и приступает к процессу выработки ключей.
	\end{enumerate}

	Единственным отличием в полезной нагрузке Node info для устройств на основе S2 Security является
	поддержка класса команды 0x9F – COMMAND\_ \newline \_CLASS\_SECURITY\_2. Стоит отметить, что
	вся информация в Node info является незашифрованной. Таким образом, активный атакующий может
	убрать соответствующую команду из Node info и отправить подделанные данные контроллеру. Контроллер
	посчитает, что устройство не поддерживает спецификацию S2 Security, и будет выбрана уязвимая к атакам
	спецификация S0. Справедливо заметить, что в этом случае контроллер должен выдать предупреждение
	пользователю об использовании более ранней версии, однако данное предупреждение, как правило,
	игнорируется. Подделанный Node info должен содержать тот же home ID, что и у оригинального
	устройства. Поле home ID не является константным, а генерируется каждый раз при добавлении или
	перезагрузке устройства. Это значит, что злоумышленник сперва должен завладеть home ID. Эта
	задача выполнима и требует лишь пересчитывания длины и чексуммы после удаления команды о поддержке S2.
	
	Резюмирую, можно сказать, что данная атака подчёркивает проблему множества протоколов, а именно
	проблему улучшения безопасности при необходимости поддерживать старые устройства. Стоит отметить,
	что уже подключённые в сеть с использование S2 Security и успешно функционирующие устройства 
	находятся в относительной безопасности, однако новые устройства остаются подверженными уязвимости.
	
	
	\section{Wi-Fi}
	WPA2 являлся основным стандартом шифрования для Wi-Fi на протяжении 14 лет: с 2004 по 2018 год.
	Однако в 2016 году на WPA2 была разработана атака с переустановкой ключа (Key Reinstallation Attack, Krack).
	Krack $-$ это атака повторного воспроизведения \cite{cve-2017-13077}. Многократно сбрасывая одноразовый код, передаваемый 
	на третьем этапе установки соединения WPA2, злоумышленник может постепенно сопоставить зашифрованные 
	пакеты, сохранённые ранее, и узнать ключ шифрования.
	Уязвимость проявляется в самом стандарте Wi-Fi и не связана с ошибками реализации. В связи с этим любая
	корректная реализация WPA2 вероятнее всего является уязвимой. Уязвимость затрагивает все основные 
	программные платформы.
	
	При подключении нового клиента к сети Wi-Fi с защитой по WPA2 общий ключ шифрования согласуется 
	за 4 этапа. Данный ключ служит для шифрования всех пакетов данных. Однако, из-за потери отдельных 
	сообщений точка доступа (роутер) может повторно отправлять сообщения третьего этапа до получения 
	подтверждение о его получении. Каждый раз при получении подобного сообщения клиент устанавливает 
	уже имеющийся ключ шифрования. На практике злоумышленник заставляет жертву выполнить переустановку
	ключа.
	
	Благодаря повторному использованию ключа шифрования появляется возможность воспроизведение пакетов, 
	расшифрования и подделки содержания. При определённых условиях злоумышленник способен осуществлять 
	атаки типа «человек посередине».
	
	С появлением стандарта WPA3 данная уязвимость была устранена благодаря введению SAE (Simultaneous 
	Authentication of Equals).
	