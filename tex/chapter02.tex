\chapter{Безопасность сетевых протоколов IoT}

	\section{ZigBee}
	\label{zigbe-security section}
	
	Безопасность работы ZigBee базируется в первую очередь на стандарте IEEE 802.15.4, который реализует
	протокол. Сам стандарт опирается на правильное управление симметричными ключами и корректную 
	реализацию методов и политик безопасности. Кроме того, модель сети ZigBee уделяет особое внимание 
	соображениям безопасности по причине формирования структуры сети <<на лету>> (ad-hoc сети), 
	поскольку такие сети могут быть физически доступны для внешних устройств.
	
	В силу своей дешевизны протокол предполагает открытую модель, в которой сетевые
	уровни доверяют друг другу. Следовательно, криптографическая защита существует только между
	устройствами, но не между уровнями одного устройствами. Этот факт позволяет переиспользовать
	ключи на разных уровнях.
	
	Среди других допущений предполагается надёжное хранение симметричных ключей шифрования.
	Ключи не должны быть доступны вне устройства в незашифрованном виде. Исключение в некоторых 
	случаях составляет конфигурация нового устройства в сети, о чём речь будет идти далее. Из-за
	дешёвой природы устройств политика безопасности ZigBee не предполагает защиту от физических
	атак на аппаратное обеспечение. Это означает, что, имея физический доступ к устройству, 
	злоумышленник будет иметь теоретическую возможность извлечь из него ключи безопасности.
	Наконец, предполагается, что производители устройств будут полностью следовать спецификации,
	а в устройствах будет присутствовать криптостойкий генератор случайных чисел. Очевидно, что
	на практике не всегда соблюдаются все из перечисленных выше допущений.
	
	Рассмотрим типы ключей безопасности протокола ZigBee. Напомним, что спецификация протокола
	описывает только сетевой и прикладной уровни, а более низкие физический и MAC уровни определены
	в стандарте IEEE 802.15.4. На сетевом уровне используется следующий ключ:
	
	\begin{itemize}
		\item Сетевой ключ (\texttt{network key}). Это ключ шифрования сообщений между всеми устройствами сети 
		(широковещательных сообщений). Генерируется TC (Trust Center, доверительным центром), в роли 
		которого выступает координатор, случайным образом. Распределяется между всеми подключающимися 
		к сети устройствами и зашифровывается с помощью pre-configured link key (о нём речь пойдёт ниже).
	\end{itemize}

	Прикладной уровень располагает б\'{о}льшим набором ключей:
	
	\begin{itemize}
		\item Предустановленный глобальный ключ соединения (\texttt{pre-configured global link key}). Используется для 
		шифрования сетевого ключа в момент его передачи от TC. Данный ключ используется в версии протокола
		ZigBee 1.0 и является одинаковым для всех узлов в сети. Он может быть предустановлен либо ZigBee, либо 
		производителем устройств. Ключ, предустановленный ZigBee (ZigbeeAlliance09), позволяет устройствам 
		от различных производителей подключаться к одной сети. Он известен заранее всем участникам:
		\begin{verbatim}
			5A 69 67 42 65 65 41 6C 6C 69 61 6E 63 65 30 39
		\end{verbatim}
		Ключ, установленный непосредственно производителем, позволяет объединяться в сеть только устройствам 
		от этого производителя. Предустановлен во все устройства, только если не используется pre-configured 
		unique link key.
		\item Предустановленный уникальный ключ соединения (\texttt{pre-configured unique link key}). В версии ZigBee 3.0
		вместо \texttt{pre-configured global link key} для передачи сетевого ключа от TC может быть использован 
		\texttt{pre-configured unique link key}. Данный ключ уникален для каждой пары TC-узел. Один из возможных
		сценариев использования следующий. Ключ располагается на устройстве в виде QR-кода. При подключении
		устройства в сеть пользователь считывает QR-код с помощью смартфона, а от смартфона ключ попадает в хаб
		(координатор). После этого хаб высылает устройству \texttt{network key}, зашифрованный на только что полученном
		ключе, для дальнейшей коммуникации.
		\item Ключ соединения доверительного центра (\texttt{Trust Center Link Key}, TCLK). Используется между 
		TC и определённым узлом. Извлекается из \texttt{pre-configured unique link key}, передаётся от TC к узлу, шифруется 
		с помощью \texttt{network key} и \texttt{pre-configured unique link key}. Предназначен для шифрования всех последующих 
		сообщений между TC и узлом, заменяя \texttt{pre-configured unique link key} (однако узел продолжает хранить 
		\texttt{pre-configured unique link key} для возможного повторного соединения в дальнейшем). Не является
		обязательным для использования ключом в сеансе.
		\item Ключ соединения приложения (\texttt{Application Link Key}). Используется между парой узлов (без TC). 
		Запрашивается у TC одним из узлов, генерируется TC случайным образом. Шифруется с помощью 
		\texttt{network key} и \texttt{pre-configured unique link key}. Может возникнуть вопрос, зачем для коммуникации двух
		устройств нужен отдельный ключ, когда уже есть \texttt{network key}. \texttt{Network key} известен всем устройствам 
		в сети, поэтому любое устройство сможет расшифровать сообщение. Если нужна защищённая коммуникация 
		для двух отдельных устройств, TC выпускает данный ключ. Не является обязательным для использования 
		ключом в сеансе.
	\end{itemize}

	ZigBee использует симметричное шифрование AES в режиме CCM (counter with CBC-MAC) с длиной ключа 128 бит для 
	реализации своих механизмов безопасности. Контроль целостности осуществляется за счёт имитовставки, которая 
	в стандарте носит название MIC (Message Integrity Code) в целях избежания путаницы с названием уровня MAC.

	
	\section{Z-Wave}
	
	До 2008 года в спецификации Z-Wave не было никаких упоминаний о способах защиты каналов связи. 
	Таким образом, все устройства Z-Wave коммуницировали открыто. Это означало, что любая сеть Z-Wave 
	была доступна извне и взламывать её было не нужно. В 2008 в спецификацию было добавлено понятие 
	шифрования (Z-Wave S0 Security), а в качестве алгоритма шифрования был выбран AES 
	в режиме CBC с длиной ключа 128 бит. 
	Это изменение было призвано решить проблему распространения устройств Z-Wave. Однако разработчики
	не учли мелких деталей на этапе подключения новых устройств.
	
	В 2013 году в спецификации  Z-Wave S0 Security была обнаружена уязвимость. В момент первичной 
	инициализации соединения перед началом сеанса передачи данных устройству отправляется ключ шифрования.
	На тот момент этот ключ представлял собой последовательность из 128 нулевых бит. Таким образом, злоумышленник
	мог легко подслушать первичный сеанс связи, ключ которого был заранее известен. Далее не
	составляло труда отследить последующие изменения ключей шифрования. В результате практически
	каждая Z-Wave сеть оказалась уязвимой.
	
	После этой истории репутация Z-Wave была существенно испорчена. Для решения проблемы в 2016 году
	появилась улучшенная версии спецификации Z-Wave S2 Security. В ней для первичной выработки ключей
	используется протокол Диффи-Хеллмана. Однако более детальная информация о конкретном его варианте
	(на основе эллиптических кривых или конечных полей) и уровне стойкости, а также сроке жизни ключей
	шифрования в спецификации не раскрывается.
	
	
	\section{Wi-Fi}
	
	Основными протоколами защиты информации в сетях Wi-Fi являются WEP, WPA, WPA2 и WPA3.
	
	Протокол WEP (Wired Equivalent Privacy) был разработан в 1997 году вместе с первой версией Wi-Fi.
	Для шифрования использовался алгоритм RC4 со статическим ключом длиной 64 или 128 бит. Некоторое время
	протокол успешно функционировал и был способен противостоять базовым атакам типа <<человек посередине>>.
	Недостатки заключались в слабости самого шифра RC4, а также малой длине ключа. Wi-Fi Alliance отказался 
	от использования WEP в 2004 году, официально объявив этот протокол небезопасным.
	
	В 2003 году на замену WEP пришёл протокол WPA (Wi-Fi Protected Access). WPA использует протокол 
	целостности временного ключа (TKIP) с всё той же длиной ключа 64 или 128 бит \cite{802.11i-2004}. Для шифрования
	использовался тот же самый алгоритм RC4, но синхропосылка была увеличена вдвое: с 24 до 48 бит.
	TKIP с помощью уникального базового ключа для сеанса связи динамически генерирует новый 128-битный ключ для 
	каждого пакета и таким образом предотвращает типы атак, которые скомпрометировали WEP. Несмотря
	на все улучшения протокол WPA позиционировался как временная мера для замены уязвимого протокола
	WEP.
	
	Полноценной же заменой стал протокол WPA2, который появился в использовании с 2004 года. С этого
	же года началась сертификация, а с 2006 по 2020 год сертификация WPA2 была обязательной для всех
	новых устройств с торговой маркой Wi-Fi. В качестве замены TKIP был внедрён протокол блочного 
	шифрования с имитовставкой и режимом сцепления блоков и счётчика: CCMP. TKIP использовался
	только для обратной совместимости. CCMP основан на алгоритме шифрования AES с длиной ключа 128 бит.
	Одним из преимуществ по сравнению со старыми версиями является генерация ключей шифрования во время
	соединения.
	
	В январе 2018 года Wi-Fi Alliance объявил WPA3 в качестве замены WPA2. Сертификация началась в июне 
	2018 года. Самое крупное изменение связано с новым методом аутентификации. SAE (Simultaneous 
	Authentication of Equals) явился заменой PSK (Pre-Shared Key), который использовал 4-этапное 
	установление связи в протоколе WPA2. SAE работает на основе предположения о равноправности 
	устройств, вместо того, чтобы считать одно устройство отправляющим запросы, а второе $-$ предоставляющим 
	право на подключение.  Кроме того, SAE обеспечивает защиту от <<чтения назад>>. 128-битное шифрование
	осталось минимально допустимой нормой, а для промышленных масштабов предложен вариант использования
	AES с длиной ключа 256 бит в режиме GCM с SHA-384 в качестве HMAC для контроля целостности информации.
	С выходом WPA3 появились две новые сопутствующие технологии: Easy Connect  и Enhanced Open. Первая
	позволяет сделать процесс добавления новых устройств в сеть более простым и является весьма актуальной
	для домашней автоматизации. Отныне у каждого устройства будет уникальный QR-код, который сможет
	работать в качестве открытого ключа. Для добавления устройства необходимо будет просканировать код 
	при помощи смартфона, который уже находится в сети. После сканирования между устройством и сетью 
	произойдёт обмен ключами аутентификации для установления последующего соединения.
	Вторая технология усиливает защиту пользователей в открытых сетях, где по умолчанию нет защиты с
	аутентификацией.
	Данные технологии не зависят напрямую от WPA3, но улучшают безопасность для определённых типов сетей.
	Таким образом, вместо полной переработки безопасности Wi-Fi, WPA3 концентрируется на новых технологиях, 
	которые позволят устранить уязвимости, обнаруженные в WPA2.
	
	
	\section{Сравнение безопасности}
	
	Схожие в техническом плане ZigBee и Z-Wave, с точки зрения безопасности также не имеют
	существенных различий: оба протокола используют симметричный алгоритм блочного шифрования
	AES с длиной ключа 128 бит. Единственным отличием является метод распределения ключей: в Z-Wave
	используется протокол Диффи-Хеллмана, в то время как в ZigBee этот процесс по-прежнему доверен
	центру управления безопасностью.
	
	В сетях на основе Wi-Fi безопасности уделяется значительно больше внимания в силу их повсеместного
	распространения. В контексте домашней автоматизации и некоторых других сфер, в которых Wi-Fi
	конкурирует с ZigBee и Z-Wave, отличия всё также незначительны. Для шифрования используются
	дополнительные надстройки и протоколы, но в основе лежит AES-128. В случае промышленного
	использования для Wi-Fi применяются более продвинутые технологии защиты информации.
	